<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thinkcruit - Intelligent Recruitment Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.12/marked.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pop { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .page { display: none; min-height: calc(100vh - 150px); animation: fadeIn 0.3s ease-in; }
        .page.active { display: block; }
        .drag-over { background-color: rgba(0, 123, 255, 0.1); border-color: #007bff; }
        #job-description-output { white-space: pre-wrap; }
        .chat-message { max-width: 75%; word-wrap: break-word; }
    </style>
</head>
<body class="bg-gray-50 font-sans overflow-x-hidden">
    <nav class="bg-gradient-to-r from-blue-600 to-teal-500 text-white sticky top-0 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <a href="#" class="flex items-center space-x-2 group">
                <img src="/static/Tariq.png" alt="Logo" class="h-10 transition-transform duration-300 group-hover:rotate-12">
                <span class="text-2xl font-bold">Thinkcruit</span>
            </a>
            <div class="flex items-center space-x-6">
                <a href="#" class="nav-link" data-page="home"><i class="fas fa-home mr-2"></i>Home</a>
                <a href="#" class="nav-link" data-page="candidates"><i class="fas fa-users mr-2"></i>Candidates</a>
                <a href="#" class="nav-link" data-page="chat"><i class="fas fa-comments mr-2"></i>Chat</a>
                <a href="#" class="nav-link" data-page="reports"><i class="fas fa-chart-bar mr-2"></i>Reports</a>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div id="home" class="page active">
            <div class="text-3xl font-semibold text-gray-800 mb-4">Intelligent Recruitment Assistant</div>
            <p class="text-gray-600 mb-6">Upload resumes and job descriptions to find the best candidates with AI-powered analysis</p>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="text-lg font-medium text-gray-700 mb-4 flex items-center"><i class="fas fa-upload mr-2"></i>Upload Resumes & Job Description</div>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 hover:bg-gray-50 transition-all duration-300 relative" id="upload-area" aria-live="polite">
                        <i class="fas fa-cloud-upload-alt text-4xl text-blue-500 mb-2"></i>
                        <h4 class="text-lg font-medium">Drag & Drop Resumes Here</h4>
                        <p class="text-gray-500">Supported formats: PDF, DOCX</p>
                        <input type="file" id="resume-upload" class="hidden" multiple accept=".pdf,.docx">
                        <button class="mt-4 inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors" id="browse-btn">
                            <i class="fas fa-folder-open mr-2"></i>Browse Files
                        </button>
                    </div>
                    <div class="mt-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Job Description</label>
                        <textarea id="job-description" rows="5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter job description here..."></textarea>
                    </div>
                    <form id="job-description-form" class="mt-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Key Terms (comma-separated)</label>
                        <input type="text" id="key-terms-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., Python, Machine Learning, Leadership">
                        <button type="submit" class="mt-4 w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center" aria-label="Generate Job Description">
                            <i class="fas fa-magic mr-2"></i>Generate Job Description
                        </button>
                    </form>
                    <div id="job-description-output" class="mt-4 p-4 bg-white border border-gray-200 rounded-lg"></div>
                    <div class="mt-6 flex justify-between items-center">
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="rag-toggle" class="mr-2" checked>
                                <span class="text-sm text-gray-700">Enable RAG Processing</span>
                            </label>
                            <div class="mt-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Top Candidates to Shortlist</label>
                                <input type="number" id="top-n" value="5" min="1" max="20" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <button id="process-resumes" class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors flex items-center" aria-label="Process Resumes">
                            <i class="fas fa-cogs mr-2"></i>Process Resumes
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-6">
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <div class="text-lg font-medium text-gray-700 mb-4 flex items-center"><i class="fas fa-tasks mr-2"></i>Processing Status</div>
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-sm font-medium">Resumes Uploaded</span>
                            <span id="resume-count" class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded">0</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                            <div id="resume-progress" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-sm font-medium">Vector Database</span>
                            <span id="vector-status" class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded">Offline (0 resumes)</span>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <div class="text-lg font-medium text-gray-700 mb-4 flex items-center"><i class="fas fa-chart-line mr-2"></i>Analytics</div>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between text-sm">
                                    <span>Technical Skills Match</span>
                                    <span id="tech-match">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div id="tech-progress" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm">
                                    <span>Experience Level</span>
                                    <span id="exp-level">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div id="exp-progress" class="bg-green-600 h-2.5 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm">
                                    <span>Cultural Fit</span>
                                    <span id="cultural-fit">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div id="cultural-progress" class="bg-purple-600 h-2.5 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="candidates" class="page">
            <div class="text-3xl font-semibold text-gray-800 mb-4">Candidate Analysis</div>
            <p class="text-gray-600 mb-6">Review and compare candidate profiles based on qualifications and match score</p>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="text-lg font-medium text-gray-700 mb-4 flex items-center"><i class="fas fa-list-ol mr-2"></i>Ranked Candidates</div>
                    <input type="text" id="candidate-search" class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500" placeholder="Search candidates..." aria-label="Search candidates">
                    <div id="candidate-list" class="max-h-96 overflow-y-auto"></div>
                    <div id="email-buttons" class="mt-6 space-y-4 hidden">
                        <button id="send-congratulatory-emails" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center" aria-label="Send Shortlist Emails">
                            <i class="fas fa-check-circle mr-2"></i>Send Shortlist Emails
                        </button>
                        <button id="send-feedback-emails" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center" aria-label="Send Feedback Emails">
                            <i class="fas fa-envelope mr-2"></i>Send Feedback Emails
                        </button>
                        <input type="text" id="interview-schedule-input" class="w-full p-2 border border-gray-300 rounded-lg mb-2" placeholder="e.g., July 10, 2025, 10:00 AM PKT via Zoom">
                        <button id="send-interview-schedule" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center" aria-label="Send Interview Schedule">
                            <i class="fas fa-calendar mr-2"></i>Send Interview Schedule
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="text-lg font-medium text-gray-700 mb-4 flex items-center"><i class="fas fa-user-tie mr-2"></i>Candidate Details</div>
                    <div id="candidate-details" class="max-h-96 overflow-y-auto"></div>
                    <div id="interview-chat" class="mt-6 hidden">
                        <div class="text-lg font-medium text-gray-700 mb-4 flex items-center"><i class="fas fa-comments mr-2"></i>Interview Chat</div>
                        <div id="interview-messages" class="max-h-64 overflow-y-auto mb-4 p-4 bg-gray-50 rounded-lg"></div>
                        <div class="flex space-x-2">
                            <input type="text" id="interview-input" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Type your question..." aria-label="Interview input">
                            <button id="send-interview-question" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center" aria-label="Send Interview Question">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button id="end-interview" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors flex items-center" aria-label="End Interview">
                                <i class="fas fa-stop mr-2"></i>End Interview
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="chat" class="page">
            <div class="text-3xl font-semibold text-gray-800 mb-4">Recruitment Assistant</div>
            <p class="text-gray-600 mb-6">Ask questions about candidates, job requirements, and get AI-powered insights</p>
            <div class="max-w-3xl mx-auto">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="text-lg font-medium text-gray-700 mb-4 flex items-center"><i class="fas fa-comments mr-2"></i>AI Recruitment Assistant</div>
                    <div id="chat-messages" class="max-h-96 overflow-y-auto mb-4 p-4 bg-gray-50 rounded-lg"></div>
                    <div class="flex space-x-2">
                        <input type="text" id="chat-input" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ask a question about the candidates..." aria-label="Chat input">
                        <button id="send-message" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center" aria-label="Send Message">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <p class="text-gray-500 text-sm mt-2">Try: "Who has the most experience with Python?" or "Best candidates for a senior role?"</p>
                </div>
            </div>
        </div>

        <div id="reports" class="page">
            <div class="text-3xl font-semibold text-gray-800 mb-4">Recruitment Reports</div>
            <p class="text-gray-600 mb-6">Generate and download comprehensive reports comparing candidate qualifications</p>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="text-lg font-medium text-gray-700 mb-4 flex items-center"><i class="fas fa-file-pdf mr-2"></i>Generate Report</div>
                    <div class="space-y-4">
                        <input type="text" id="report-title" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Enter report title" aria-label="Report title">
                        <select id="candidate-select" multiple class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" aria-label="Select candidates"></select>
                        <button id="generate-report" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center" aria-label="Generate Report">
                            <i class="fas fa-magic mr-2"></i>Generate Report
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="text-lg font-medium text-gray-700 mb-4 flex items-center"><i class="fas fa-history mr-2"></i>Recent Reports</div>
                    <div id="recent-reports" class="text-center py-6 text-gray-500">
                        <i class="fas fa-file-alt text-2xl mb-2"></i>
                        <p>No reports generated yet</p>
                        <small>Generate your first report to see it here</small>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="text-lg font-medium text-gray-700 mb-4 flex items-center"><i class="fas fa-file-alt mr-2"></i>Report Preview</div>
                <div id="report-preview" class="max-h-96 overflow-y-auto mb-4 p-4 bg-gray-50 rounded-lg"></div>
                <div class="flex justify-end space-x-2">
                    <button id="download-pdf" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors flex items-center" disabled aria-label="Download PDF">
                        <i class="fas fa-download mr-2"></i>Download PDF
                    </button>
                    <button id="export-csv" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center" disabled aria-label="Export CSV">
                        <i class="fas fa-file-csv mr-2"></i>Export to CSV
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-gradient-to-r from-gray-800 to-indigo-900 text-white py-8 mt-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h5 class="text-lg font-semibold mb-4">RecruitAI</h5>
                    <p class="text-sm">AI-powered recruitment assistant to streamline hiring and find top talent efficiently.</p>
                </div>
                <div>
                    <h5 class="text-lg font-semibold mb-4">Features</h5>
                    <div class="space-y-2">
                        <a href="#" class="text-sm text-gray-300 hover:text-white transition-colors">Resume Parsing</a>
                        <a href="#" class="text-sm text-gray-300 hover:text-white transition-colors">Candidate Ranking</a>
                        <a href="#" class="text-sm text-gray-300 hover:text-white transition-colors">AI Analysis</a>
                        <a href="#" class="text-sm text-gray-300 hover:text-white transition-colors">Reports</a>
                        <a href="#" class="text-sm text-gray-300 hover:text-white transition-colors">Chat Assistant</a>
                    </div>
                </div>
                <div>
                    <h5 class="text-lg font-semibold mb-4">Resources</h5>
                    <div class="space-y-2">
                        <a href="#" class="text-sm text-gray-300 hover:text-white transition-colors">Documentation</a>
                        <a href="#" class="text-sm text-gray-300 hover:text-white transition-colors">API Reference</a>
                        <a href="#" class="text-sm text-gray-300 hover:text-white transition-colors">Support</a>
                    </div>
                </div>
                <div>
                    <h5 class="text-lg font-semibold mb-4">Contact</h5>
                    <p class="text-sm">Email: thinkrecruit1@gmail.com</p>
                </div>
            </div>
            <div class="text-center mt-6 border-t border-gray-700 pt-4">
                <p class="text-sm">© 2025 Thinkcruit. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let processedCandidates = [];
            let currentInterview = null;
            const state = { loading: false, emailConfigSet: true }; // Hardcoded email config assumed

            // Debounce function to limit rapid API calls
            function debounce(func, wait) {
                let timeout;
                return function (...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }

            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                    const page = document.getElementById(link.dataset.page);
                    page.classList.add('active');
                    if (link.dataset.page === 'candidates' && processedCandidates.length) {
                        displayCandidates(processedCandidates);
                        document.getElementById('email-buttons').classList.remove('hidden');
                    } else if (link.dataset.page === 'chat') {
                        if (document.getElementById('chat-messages').children.length === 0) {
                            addMessage("Hello! I'm your AI recruitment assistant. How can I assist you today?", 'bot');
                        }
                    } else if (link.dataset.page === 'reports' && processedCandidates.length) {
                        updateCandidateSelect();
                    } else {
                        document.getElementById('email-buttons')?.classList.add('hidden');
                    }
                });
            });

            // File Upload
            const uploadArea = document.getElementById('upload-area');
            const resumeUpload = document.getElementById('resume-upload');
            let uploadedFiles = [];
            document.getElementById('browse-btn').addEventListener('click', () => resumeUpload.click());
            resumeUpload.addEventListener('change', () => {
                const newFiles = Array.from(resumeUpload.files).filter(file => !uploadedFiles.some(f => f.name === file.name && f.size === file.size));
                uploadedFiles = [...uploadedFiles, ...newFiles];
                document.getElementById('resume-count').textContent = uploadedFiles.length;
                document.getElementById('resume-progress').style.width = '0%';
                updateAnalytics();
                resumeUpload.value = '';
            });
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });
            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('drag-over'));
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                const newFiles = Array.from(e.dataTransfer.files).filter(file => !uploadedFiles.some(f => f.name === file.name && f.size === file.size));
                uploadedFiles = [...uploadedFiles, ...newFiles];
                document.getElementById('resume-count').textContent = uploadedFiles.length;
                updateAnalytics();
            });

            // Process Resumes
            document.getElementById('process-resumes').addEventListener('click', () => {
                const jobDesc = document.getElementById('job-description').value.trim();
                if (!jobDesc) return showToast('warning', 'Please enter a job description');
                if (!uploadedFiles.length) return showToast('warning', 'Please upload at least one resume');
                if (state.loading) return;
                state.loading = true;
                const btn = document.getElementById('process-resumes');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
                const formData = new FormData();
                formData.append('job_description', jobDesc);
                formData.append('rag_mode', document.getElementById('rag-toggle').checked);
                uploadedFiles.forEach(file => formData.append('resumes', file));
                fetch('/api/process_resumes', { method: 'POST', body: formData })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            showToast('error', data.error);
                            return;
                        }
                        processedCandidates = data.map(c => ({ ...c, id: c.id || crypto.randomUUID(), selected: c.selected || false }));
                        displayCandidates(processedCandidates);
                        updateVectorDBStatus();
                        updateAnalytics();
                        updateCandidateSelect();
                        showToast('success', `${processedCandidates.length} resumes processed`);
                    })
                    .catch(error => {
                        console.error('Process resumes error:', error);
                        showToast('error', `Failed to process resumes: ${error.message}`);
                    })
                    .finally(() => {
                        state.loading = false;
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-cogs mr-2"></i>Process Resumes';
                        document.getElementById('resume-progress').style.width = '100%';
                    });
            });

            // Update Vector DB Status
            function updateVectorDBStatus() {
                fetch('/api/vector_db_status')
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            showToast('error', data.error);
                            return;
                        }
                        const status = data.initialized ? 'Online' : 'Offline';
                        const statusClass = data.initialized ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                        const count = data.resume_count || 0;
                        document.getElementById('vector-status').textContent = `${status} (${count} resumes)`;
                        document.getElementById('vector-status').className = `text-xs font-medium px-2.5 py-0.5 rounded ${statusClass}`;
                    })
                    .catch(error => {
                        console.error('Vector DB status error:', error);
                        showToast('error', `Failed to fetch database status: ${error.message}`);
                    });
            }

            // Display Candidates
            function displayCandidates(candidates) {
                const container = document.getElementById('candidate-list');
                container.innerHTML = '';
                if (!candidates?.length) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-users text-3xl mb-2"></i>
                            <h4>No Candidates Processed</h4>
                            <p>Upload resumes to see rankings</p>
                        </div>
                    `;
                    return;
                }
                const topN = parseInt(document.getElementById('top-n').value) || 5;
                candidates.sort((a, b) => (b.score || 0) - (a.score || 0)).slice(0, topN).forEach((candidate, index) => {
                    const candidateCard = document.createElement('div');
                    candidateCard.className = 'p-4 border-b border-gray-200 hover:bg-gray-50 cursor-pointer';
                    candidateCard.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <input type="checkbox" class="candidate-checkbox mr-2" data-id="${candidate.id}" ${candidate.selected ? 'checked' : ''}>
                                <div>
                                    <h4 class="font-semibold text-gray-800">${candidate.name || 'Unknown'}</h4>
                                    <p class="text-sm text-gray-500">${candidate.email || 'No email'}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm font-medium text-blue-600">${candidate.score || 0}%</span>
                                <button class="start-interview-btn bg-blue-600 text-white py-1 px-3 rounded-lg hover:bg-blue-700 transition-colors" data-id="${candidate.id}">
                                    <i class="fas fa-comments mr-1"></i>Interview
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(candidateCard);
                    candidateCard.querySelector('.candidate-checkbox').addEventListener('change', (e) => {
                        candidate.selected = e.target.checked;
                    });
                    candidateCard.querySelector('.start-interview-btn').addEventListener('click', () => startInterview(candidate));
                    candidateCard.addEventListener('click', (e) => {
                        if (e.target.type !== 'checkbox' && !e.target.closest('.start-interview-btn')) {
                            displayCandidateDetails(candidate);
                        }
                    });
                });
                document.getElementById('email-buttons').classList.remove('hidden');
            }

            // Display Candidate Details
            function displayCandidateDetails(candidate) {
                const container = document.getElementById('candidate-details');
                container.innerHTML = `
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">${candidate.name || 'Unknown'}</h3>
                    <p><strong>Email:</strong> ${candidate.email || 'N/A'}</p>
                    <p><strong>Phone:</strong> ${candidate.phone || 'N/A'}</p>
                    <p><strong>Skills:</strong> ${candidate.skills?.join(', ') || 'None'}</p>
                    <p><strong>Score:</strong> ${candidate.score || 0}%</p>
                    <h4 class="font-semibold mt-4">Experience</h4>
                    ${candidate.experience?.map(exp => `
                        <div class="mb-2">
                            <p><strong>${exp.title}</strong> at ${exp.company}</p>
                            <p class="text-sm text-gray-500">${exp.duration}</p>
                            <p class="text-sm">${exp.description}</p>
                        </div>
                    `).join('') || '<p>No experience listed</p>'}
                    <h4 class="font-semibold mt-4">Education</h4>
                    ${candidate.education?.map(edu => `
                        <div class="mb-2">
                            <p><strong>${edu.degree}</strong> - ${edu.institution}</p>
                            <p class="text-sm text-gray-500">${edu.year}</p>
                        </div>
                    `).join('') || '<p>No education listed</p>'}
                    <h4 class="font-semibold mt-4">Strengths</h4>
                    <ul class="list-disc pl-5">${candidate.strengths?.map(s => `<li>${s}</li>`).join('') || '<li>None</li>'}</ul>
                    <h4 class="font-semibold mt-4">Red Flags</h4>
                    <ul class="list-disc pl-5">${candidate.red_flags?.map(r => `<li>${r}</li>`).join('') || '<li>None</li>'}</ul>
                    <h4 class="font-semibold mt-4">Justification</h4>
                    <p>${candidate.justification || 'No justification provided'}</p>
                `;
                document.getElementById('interview-chat').classList.add('hidden');
            }

            // Start Interview
            function startInterview(candidate) {
                const jobDesc = document.getElementById('job-description').value.trim();
                if (!jobDesc) {
                    showToast('warning', 'Please enter a job description before starting an interview');
                    return;
                }
                if (state.loading) return;
                state.loading = true;
                const btn = document.querySelector(`.start-interview-btn[data-id="${candidate.id}"]`);
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Starting...';
                fetch('/api/start_interview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        candidate_email: candidate.email,
                        candidate_name: candidate.name,
                        job_description: jobDesc
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            showToast('error', data.error);
                            return;
                        }
                        currentInterview = { id: data.interview_id, candidate: candidate };
                        document.getElementById('interview-chat').classList.remove('hidden');
                        document.getElementById('interview-messages').innerHTML = `
                            <div class="chat-message mb-2 p-3 bg-blue-100 text-blue-800 rounded-lg">
                                <strong>Interviewer:</strong> ${data.current_question}
                            </div>
                        `;
                        const interviewLink = `http://${window.location.host}/candidate_interview?interview_id=${data.interview_id}&candidate_name=${encodeURIComponent(candidate.name)}`;
                        console.log(`Interview link: ${interviewLink}`);
                        showToast('info', `Interview started. Link for ${candidate.name}: <a href="${interviewLink}" target="_blank">${interviewLink}</a> (Copy and send manually for now)`);
                        pollInterviewState();
                    })
                    .catch(error => {
                        console.error('Start interview error:', error);
                        showToast('error', `Failed to start interview: ${error.message}`);
                    })
                    .finally(() => {
                        state.loading = false;
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-comments mr-1"></i>Interview';
                    });
            }

            // Poll Interview State
            const pollInterviewState = debounce(() => {
                if (!currentInterview) return;
                fetch(`/api/get_interview_state?interview_id=${encodeURIComponent(currentInterview.id)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            showToast('error', data.error);
                            document.getElementById('interview-chat').classList.add('hidden');
                            currentInterview = null;
                            return;
                        }
                        const messages = document.getElementById('interview-messages');
                        messages.innerHTML = '';
                        data.messages.forEach(msg => {
                            const messageClass = msg.sender === 'Candidate' ? 'bg-blue-100 text-blue-800 ml-auto' : 'bg-gray-200 text-gray-800';
                            messages.innerHTML += `
                                <div class="chat-message mb-2 p-3 ${messageClass} rounded-lg">
                                    <strong>${msg.sender}:</strong> ${msg.text}
                                </div>
                            `;
                        });
                        messages.scrollTop = messages.scrollHeight;
                        if (data.status === 'ended') {
                            showToast('info', 'Interview has ended');
                            document.getElementById('interview-chat').classList.add('hidden');
                            currentInterview = null;
                        } else {
                            setTimeout(pollInterviewState, 5000); // Poll every 5 seconds
                        }
                    })
                    .catch(error => {
                        console.error('Poll interview state error:', error);
                        showToast('error', `Failed to fetch interview state: ${error.message}`);
                        document.getElementById('interview-chat').classList.add('hidden');
                        currentInterview = null;
                    });
            }, 500);

            // Send Interview Question
            document.getElementById('send-interview-question').addEventListener('click', () => {
                const question = document.getElementById('interview-input').value.trim();
                if (!question || !currentInterview) return;
                if (state.loading) return;
                state.loading = true;
                const btn = document.getElementById('send-interview-question');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                fetch('/api/submit_agent_question', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interview_id: currentInterview.id, question })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            showToast('error', data.error);
                            return;
                        }
                        const messages = document.getElementById('interview-messages');
                        messages.innerHTML += `
                            <div class="chat-message mb-2 p-3 bg-blue-100 text-blue-800 rounded-lg ml-auto">
                                <strong>You:</strong> ${question}
                            </div>
                            <div class="chat-message mb-2 p-3 bg-gray-200 text-gray-800 rounded-lg">
                                <strong>Interviewer:</strong> ${data.next_question || 'Thank you for your question.'}
                            </div>
                        `;
                        document.getElementById('interview-input').value = '';
                        messages.scrollTop = messages.scrollHeight;
                        showToast('success', 'Question submitted');
                    })
                    .catch(error => {
                        console.error('Submit question error:', error);
                        showToast('error', `Failed to submit question: ${error.message}`);
                    })
                    .finally(() => {
                        state.loading = false;
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                    });
            });

            // End Interview
            document.getElementById('end-interview').addEventListener('click', () => {
                if (!currentInterview) return;
                if (state.loading) return;
                state.loading = true;
                const btn = document.getElementById('end-interview');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Ending...';
                fetch('/api/end_interview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interview_id: currentInterview.id })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            showToast('error', data.error);
                            return;
                        }
                        showToast('success', `Interview ended. Summary sent to hiring team.`);
                        document.getElementById('interview-messages').innerHTML = '<p class="text-gray-500 text-center">Interview has ended.</p>';
                        document.getElementById('interview-chat').classList.add('hidden');
                        document.getElementById('report-preview').innerHTML = marked.parse(data.summary);
                        currentInterview = null;
                    })
                    .catch(error => {
                        console.error('End interview error:', error);
                        showToast('error', `Failed to end interview: ${error.message}`);
                    })
                    .finally(() => {
                        state.loading = false;
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-stop mr-2"></i>End Interview';
                    });
            });

            // Send Congratulatory Emails
            document.getElementById('send-congratulatory-emails').addEventListener('click', () => {
                const selectedCandidates = processedCandidates.filter(c => c.selected);
                if (!selectedCandidates.length) {
                    showToast('warning', 'Please select at least one candidate');
                    return;
                }
                if (state.loading) return;
                state.loading = true;
                const btn = document.getElementById('send-congratulatory-emails');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
                fetch('/api/send_congratulatory_email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ selected_candidates: selectedCandidates })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            showToast('error', data.error);
                            return;
                        }
                        showToast('success', `Sent ${data.success_count} of ${data.total} emails`);
                    })
                    .catch(error => {
                        console.error('Send congratulatory emails error:', error);
                        showToast('error', `Failed to send emails: ${error.message}`);
                    })
                    .finally(() => {
                        state.loading = false;
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Send Shortlist Emails';
                    });
            });

            // Send Feedback Emails
            document.getElementById('send-feedback-emails').addEventListener('click', () => {
                const unselectedCandidates = processedCandidates.filter(c => !c.selected);
                if (!unselectedCandidates.length) {
                    showToast('warning', 'No unselected candidates to send feedback');
                    return;
                }
                if (state.loading) return;
                state.loading = true;
                const btn = document.getElementById('send-feedback-emails');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
                fetch('/api/send_feedback_email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ unselected_candidates: unselectedCandidates })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            showToast('error', data.error);
                            return;
                        }
                        showToast('success', `Sent ${data.success_count} of ${data.total} feedback emails`);
                    })
                    .catch(error => {
                        console.error('Send feedback emails error:', error);
                        showToast('error', `Failed to send feedback emails: ${error.message}`);
                    })
                    .finally(() => {
                        state.loading = false;
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-envelope mr-2"></i>Send Feedback Emails';
                    });
            });

            // Send Interview Schedule
            document.getElementById('send-interview-schedule').addEventListener('click', () => {
                const selectedCandidates = processedCandidates.filter(c => c.selected);
                const schedule = document.getElementById('interview-schedule-input').value.trim();
                const jobDesc = document.getElementById('job-description').value.trim();
                if (!selectedCandidates.length) {
                    showToast('warning', 'Please select at least one candidate');
                    return;
                }
                if (!jobDesc) {
                    showToast('warning', 'Please enter a job description');
                    return;
                }
                if (!schedule) {
                    showToast('warning', 'Please enter an interview schedule');
                    return;
                }
                if (state.loading) return;
                state.loading = true;
                const btn = document.getElementById('send-interview-schedule');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
                fetch('/api/send_interview_schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ selected_candidates: selectedCandidates, schedule, job_description: jobDesc })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            showToast('error', data.error);
                            return;
                        }
                        showToast('success', `Sent ${data.success_count} of ${data.total} interview schedule emails`);
                    })
                    .catch(error => {
                        console.error('Send interview schedule error:', error);
                        showToast('error', `Failed to send schedules: ${error.message}`);
                    })
                    .finally(() => {
                        state.loading = false;
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-calendar mr-2"></i>Send Interview Schedule';
                    });
            });

            // Generate Job Description
            document.getElementById('job-description-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const keyTerms = document.getElementById('key-terms-input').value.split(',').map(t => t.trim()).filter(t => t);
                if (!keyTerms.length) {
                    showToast('warning', 'Please enter at least one key term');
                    return;
                }
                if (state.loading) return;
                state.loading = true;
                const btn = document.querySelector('#job-description-form button');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';
                fetch('/api/generate_job_description', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key_terms: keyTerms })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            showToast('error', data.error);
                            return;
                        }
                        document.getElementById('job-description').value = data.job_description.replace(/#{1,6}\s/g, '').trim();
                        document.getElementById('job-description-output').innerHTML = marked.parse(data.job_description);
                        showToast('success', 'Job description generated');
                    })
                    .catch(error => {
                        console.error('Generate job description error:', error);
                        showToast('error', `Failed to generate job description: ${error.message}`);
                    })
                    .finally(() => {
                        state.loading = false;
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-magic mr-2"></i>Generate Job Description';
                    });
            });

            // Generate Report
            document.getElementById('generate-report').addEventListener('click', () => {
                const selectedOptions = Array.from(document.getElementById('candidate-select').selectedOptions).map(opt => opt.value);
                const selectedCandidates = processedCandidates.filter(c => selectedOptions.includes(c.id));
                const jobDesc = document.getElementById('job-description').value.trim();
                const reportTitle = document.getElementById('report-title').value.trim();
                if (!selectedCandidates.length) {
                    showToast('warning', 'Please select at least one candidate');
                    return;
                }
                if (!jobDesc) {
                    showToast('warning', 'Please enter a job description');
                    return;
                }
                if (state.loading) return;
                state.loading = true;
                const btn = document.getElementById('generate-report');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';
                fetch('/api/generate_report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ candidates: selectedCandidates, job_description: jobDesc })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            showToast('error', data.error);
                            return;
                        }
                        document.getElementById('report-preview').innerHTML = marked.parse(data.report);
                        document.getElementById('recent-reports').innerHTML = `
                            <div class="text-gray-700">
                                <p><strong>${reportTitle || 'Report'}</strong></p>
                                <p class="text-sm text-gray-500">Generated on ${new Date().toLocaleString()}</p>
                            </div>
                        `;
                        document.getElementById('export-csv').disabled = false;
                        document.getElementById('download-pdf').disabled = false;
                        showToast('success', 'Report generated successfully');
                    })
                    .catch(error => {
                        console.error('Generate report error:', error);
                        showToast('error', `Failed to generate report: ${error.message}`);
                    })
                    .finally(() => {
                        state.loading = false;
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-magic mr-2"></i>Generate Report';
                    });
            });

            // Export CSV
            document.getElementById('export-csv').addEventListener('click', () => {
                const selectedOptions = Array.from(document.getElementById('candidate-select').selectedOptions).map(opt => opt.value);
                const selectedCandidates = processedCandidates.filter(c => selectedOptions.includes(c.id));
                if (!selectedCandidates.length) {
                    showToast('warning', 'Please select at least one candidate');
                    return;
                }
                if (state.loading) return;
                state.loading = true;
                const btn = document.getElementById('export-csv');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Exporting...';
                fetch('/api/export_csv', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ candidates: selectedCandidates })
                })
                    .then(response => response.blob())
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'candidate_ranking.csv';
                        a.click();
                        window.URL.revokeObjectURL(url);
                        showToast('success', 'CSV exported successfully');
                    })
                    .catch(error => {
                        console.error('Export CSV error:', error);
                        showToast('error', `Failed to export CSV: ${error.message}`);
                    })
                    .finally(() => {
                        state.loading = false;
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-file-csv mr-2"></i>Export to CSV';
                    });
            });

            // Download PDF (Updated to include job_description)
            document.getElementById('download-pdf').addEventListener('click', () => {
                const selectedOptions = Array.from(document.getElementById('candidate-select').selectedOptions).map(opt => opt.value);
                const selectedCandidates = processedCandidates.filter(c => selectedOptions.includes(c.id));
                const jobDesc = document.getElementById('job-description').value.trim();
                if (!selectedCandidates.length) {
                    showToast('warning', 'Please select at least one candidate');
                    return;
                }
                if (!jobDesc) {
                    showToast('warning', 'Please enter a job description');
                    return;
                }
                if (state.loading) return;
                state.loading = true;
                const btn = document.getElementById('download-pdf');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Downloading...';
                fetch('/api/download_pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ candidates: selectedCandidates, job_description: jobDesc })
                })
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to generate PDF');
                        return response.blob();
                    })
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'recruitment_report.pdf';
                        a.click();
                        window.URL.revokeObjectURL(url);
                        showToast('success', 'PDF downloaded successfully');
                    })
                    .catch(error => {
                        console.error('Download PDF error:', error);
                        showToast('error', `Failed to download PDF: ${error.message}`);
                    })
                    .finally(() => {
                        state.loading = false;
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-download mr-2"></i>Download PDF';
                    });
            });

            // Chat Assistant
            document.getElementById('send-message').addEventListener('click', () => {
                const query = document.getElementById('chat-input').value.trim();
                const jobDesc = document.getElementById('job-description').value.trim();
                if (!query) {
                    showToast('warning', 'Please enter a question');
                    return;
                }
                if (!jobDesc) {
                    showToast('warning', 'Please enter a job description');
                    return;
                }
                if (state.loading) return;
                state.loading = true;
                const btn = document.getElementById('send-message');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                addMessage(query, 'user');
                document.getElementById('chat-input').value = '';
                fetch('/api/ask_question', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, candidates: processedCandidates, job_description: jobDesc })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            showToast('error', data.error);
                            return;
                        }
                        addMessage(data.response, 'bot');
                        showToast('success', 'Response received');
                    })
                    .catch(error => {
                        console.error('Chat error:', error);
                        showToast('error', `Failed to get response: ${error.message}`);
                    })
                    .finally(() => {
                        state.loading = false;
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                    });
            });

            // Update Candidate Select
            function updateCandidateSelect() {
                const select = document.getElementById('candidate-select');
                select.innerHTML = '';
                processedCandidates.forEach(candidate => {
                    const option = document.createElement('option');
                    option.value = candidate.id;
                    option.textContent = candidate.name || 'Unknown';
                    if (candidate.selected) option.selected = true;
                    select.appendChild(option);
                });
            }

            // Update Analytics
            function updateAnalytics() {
                const candidates = processedCandidates;
                if (!candidates.length) {
                    document.getElementById('tech-match').textContent = '0%';
                    document.getElementById('tech-progress').style.width = '0%';
                    document.getElementById('exp-level').textContent = '0%';
                    document.getElementById('exp-progress').style.width = '0%';
                    document.getElementById('cultural-fit').textContent = '0%';
                    document.getElementById('cultural-progress').style.width = '0%';
                    return;
                }
                const avgScore = candidates.reduce((sum, c) => sum + (c.score || 0), 0) / candidates.length;
                const avgExp = candidates.reduce((sum, c) => sum + (c.experience?.length || 0), 0) / candidates.length;
                document.getElementById('tech-match').textContent = `${Math.round(avgScore)}%`;
                document.getElementById('tech-progress').style.width = `${Math.round(avgScore)}%`;
                document.getElementById('exp-level').textContent = `${Math.round(avgExp)} years`;
                document.getElementById('exp-progress').style.width = `${Math.min(avgExp * 10, 100)}%`;
                document.getElementById('cultural-fit').textContent = `${Math.round(avgScore / 2)}%`;
                document.getElementById('cultural-progress').style.width = `${Math.round(avgScore / 2)}%`;
            }

            // Add Chat Message
            function addMessage(text, sender) {
                const messages = document.getElementById('chat-messages');
                const messageClass = sender === 'user' ? 'bg-blue-100 text-blue-800 ml-auto' : 'bg-gray-200 text-gray-800';
                messages.innerHTML += `
                    <div class="chat-message mb-2 p-3 ${messageClass} rounded-lg">
                        <strong>${sender === 'user' ? 'You' : 'Assistant'}:</strong> ${text}
                    </div>
                `;
                messages.scrollTop = messages.scrollHeight;
            }

            // Show Toast
            function showToast(type, message) {
                const toast = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : type === 'info' ? 'bg-blue-500' : 'bg-yellow-500';
                toast.className = `flex items-center ${bgColor} text-white text-sm font-medium px-4 py-2 rounded-lg shadow-md animate-pop`;
                toast.innerHTML = `
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'info' ? 'fa-info-circle' : 'fa-exclamation-triangle'} mr-2"></i>
                    ${message}
                `;
                document.getElementById('toast-container').appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }

            // Initial Vector DB Status
            updateVectorDBStatus();
        });
    </script>
</body>
</html>